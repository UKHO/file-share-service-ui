name: $(BuildDefinitionName)_$(SourceBranchName)_$(Date:yyyyMMdd).$(BuildCounter)

parameters:
  - name: ContinueEvenIfResourcesAreGettingDestroyed
    displayName: "Continue even if resources are getting destroyed"
    type: boolean
    default: false

trigger:
  - main
  - release/*

pool: $(DeploymentPool)

variables:
  - name: BuildCounter
    value: $[counter(format('{0:yyyyMMdd}', pipeline.startTime), 1)]
  - name: Container
    value: "ukhydrographicoffice/terraform-azure-powershell:0.15.4"
  - name: DeploymentPool
    value: "UKHO Ubuntu 1804"

stages:
  - stage: Perfrom_Build_Test_Publish
    displayName: "Build (Build ,test and publish artifact )"
    jobs:
      - job:
        container: ${{variables.Container}}
        workspace:
          clean: all # what to clean up before the job runs outputs | resources | all
        displayName: "DependencyChecker Build test publish"

        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '14.x'
            displayName: 'Install Node.js'

          - script: |
              npm install -g @angular/cli
              npm install
            displayName: 'npm install'

          - script: |
              npm run build --prod
            displayName: 'npm build'
           
          - script: |
             npm install jest jest-preset-angular @types/jest --save-dev
             npm install jest-junit --save-dev
             npm test --reporters=jest-junit --reporters=default --coverage --coverageReporters=cobertura --coverageReporters=html
            displayName: 'npm test and test coverage generation'
            continueOnError: false
            
          - task: PublishTestResults@2
            condition: succeededOrFailed()
            inputs:
             testRunner: JUnit
             testResultsFiles: junit.xml
            displayName: "Publish Unit Test Results"
          

          - task: PublishCodeCoverageResults@1
            inputs:
              codeCoverageTool: 'Cobertura'
              summaryFileLocation: '$(System.DefaultWorkingDirectory)/**/*coverage.xml'
              reportDirectory: './coverage/**/*.html'
            displayName: Code Coverage
   
          - task: PublishBuildArtifacts@1
            displayName: "Publish angularapp artifacts"
            inputs:
              PathtoPublish: '$(Build.SourcesDirectory)/dist'
              ArtifactName: AngularApp

