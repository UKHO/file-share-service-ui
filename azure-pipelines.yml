name: $(BuildDefinitionName)_$(SourceBranchName)_$(Date:yyyyMMdd).$(BuildCounter)

parameters:
  - name: ContinueEvenIfResourcesAreGettingDestroyed
    displayName: "Continue even if resources are getting destroyed"
    type: boolean
    default: false

trigger:
  - main
  - release/*

pool: $(DeploymentPool)

variables:
  - name: BuildCounter
    value: $[counter(format('{0:yyyyMMdd}', pipeline.startTime), 1)]
  - name: Container
    value: "ukhydrographicoffice/terraform-azure-powershell:0.14.9"
  - name: DeploymentPool
    value: "UKHO Ubuntu 1804"
  - name: WindowPool
    value: "NautilusBuild"
  - name: coverityPool
    value: NautilusBuild
  - group: Covscan-vars

resources:
  repositories:
    - repository: covscan
      type: github
      name: UKHO/coverityscan-buildtemplates
      endpoint: UKHO
      ref: refs/heads/master

stages:  
  - stage: Devdeploy
    displayName: "Devdeploy (inc terraform, website deploy)"
    variables:
      - group: "File-Share-Service-UI-Dev-Variables"
    jobs:
      - deployment: DevDeploy
        displayName: "Dev - deploy terraform and website"
        environment: "FSS-Dev"
        container: ${{variables.Container}}
        workspace:
          clean: all
        variables:
          - group: "File share service terraform Dev"
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureCLI@2
                  displayName: "Extract Deployment Variables to deploy KV"
                  inputs:
                    azureSubscription: 'File-Share-Service-Dev-P4052'
                    scriptType: 'ps'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      az keyvault secret set --name agentRg --vault-name m-fss-ui-dev-deploy-kv --value $(agentRG)
                      az keyvault secret set --name agentSubnetName --vault-name m-fss-ui-dev-deploy-kv --value $(agentSubnetName)
                      az keyvault secret set --name agentSubscriptionId --vault-name m-fss-ui-dev-deploy-kv --value $(agentSubscriptionId)
                      az keyvault secret set --name agentVnetName --vault-name m-fss-ui-dev-deploy-kv --value $(agentVnetName)
                      az keyvault secret set --name autoTestConfig-apiurl --vault-name m-fss-ui-dev-deploy-kv --value $(autoTestConfig.apiurl)
                      az keyvault secret set --name autoTestConfig-encSizeConfig --vault-name m-fss-ui-dev-deploy-kv --value $(autoTestConfig.encSizeConfig)
                      az keyvault secret set --name autoTestConfig-password --vault-name m-fss-ui-dev-deploy-kv --value $(autoTestConfig.password)
                      az keyvault secret set --name autoTestConfig-url --vault-name m-fss-ui-dev-deploy-kv --value $(autoTestConfig.url)
                      az keyvault secret set --name autoTestConfig-user --vault-name m-fss-ui-dev-deploy-kv --value $(autoTestConfig.user)
                      az keyvault secret set --name autoTestConfig-userFullName --vault-name m-fss-ui-dev-deploy-kv --value $(autoTestConfig.userFullName)
                      az keyvault secret set --name b2cConfig-clientId --vault-name m-fss-ui-dev-deploy-kv --value $(b2cConfig.clientId)
                      az keyvault secret set --name b2cConfig-tenantName --vault-name m-fss-ui-dev-deploy-kv --value $(b2cConfig.tenantName)
                      az keyvault secret set --name deploymentResourceGroupName --vault-name m-fss-ui-dev-deploy-kv --value $(DeploymentResourceGroupName)
                      az keyvault secret set --name deploymentStorageAccountName --vault-name m-fss-ui-dev-deploy-kv --value $(DeploymentStorageAccountName)
                      az keyvault secret set --name environment --vault-name m-fss-ui-dev-deploy-kv --value $(Environment)
                      az keyvault secret set --name essConfig-apiScope --vault-name m-fss-ui-dev-deploy-kv --value $(essConfig.apiScope)
                      az keyvault secret set --name essConfig-apiUrl --vault-name m-fss-ui-dev-deploy-kv --value $(essConfig.apiUrl)
                      az keyvault secret set --name essConfig-avgSizeofENCinMB --vault-name m-fss-ui-dev-deploy-kv --value $(essConfig.avgSizeofENCinMB)
                      az keyvault secret set --name essConfig-defaultEstimatedSizeinMB --vault-name m-fss-ui-dev-deploy-kv --value $(essConfig.defaultEstimatedSizeinMB)
                      az keyvault secret set --name essConfig-MaxEncLimit --vault-name m-fss-ui-dev-deploy-kv --value $(essConfig.MaxEncLimit)
                      az keyvault secret set --name essConfig-MaxEncSelectionLimit --vault-name m-fss-ui-dev-deploy-kv --value $(essConfig.MaxEncSelectionLimit)
                      az keyvault secret set --name fssConfig-apiScope --vault-name m-fss-ui-dev-deploy-kv --value $(fssConfig.apiScope)
                      az keyvault secret set --name fssConfig-apiUrl --vault-name m-fss-ui-dev-deploy-kv --value $(fssConfig.apiUrl)
                      az keyvault secret set --name fssConfig-displayPopularSearch --vault-name m-fss-ui-dev-deploy-kv --value $(fssConfig.displayPopularSearch)
                      az keyvault secret set --name fssConfig-displaySimplifiedSearchLink --vault-name m-fss-ui-dev-deploy-kv --value $(fssConfig.displaySimplifiedSearchLink)
                      az keyvault secret set --name fssConfig-stateManagementApiUrl --vault-name m-fss-ui-dev-deploy-kv --value $(fssConfig.stateManagementApiUrl)
                      az keyvault secret set --name googleTagManagerId --vault-name m-fss-ui-dev-deploy-kv --value $(GoogleTagManagerId)
                      az keyvault secret set --name service-dns-url --vault-name m-fss-ui-dev-deploy-kv --value $(SERVICE_DNS_URL)
                      az keyvault secret set --name spokeRG --vault-name m-fss-ui-dev-deploy-kv --value $(spokeRG)
                      az keyvault secret set --name spokeSubnetName --vault-name m-fss-ui-dev-deploy-kv --value $(spokeSubnetName)
                      az keyvault secret set --name spokeVnetName --vault-name m-fss-ui-dev-deploy-kv --value $(spokeVnetName)
                      az keyvault secret set --name waitTimeInMinute --vault-name m-fss-ui-dev-deploy-kv --value $(waitTimeInMinute)
                      az keyvault secret set --name whiteListedIps --vault-name m-fss-ui-dev-deploy-kv --value $(whiteListedIps)
      
  - stage: QAdeploy
    displayName: "QAdeploy (inc terraform, website deploy)"
    variables:
      - group: "File-Share-Service-UI-QA-Variables"
    jobs:
      - deployment: QADeploy
        displayName: "QA - deploy terraform and website"
        environment: "FSS-QA"
        container: ${{variables.Container}}
        workspace:
          clean: all
        variables:
          - group: "File share service terraform QA"
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureCLI@2
                  displayName: "Extract Deployment Variables to deploy KV"
                  inputs:
                    azureSubscription: 'File-Share-Service-QA-P4052'
                    scriptType: 'ps'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      az keyvault secret set --name agentRg --vault-name m-fss-ui-qa-deploy-kv --value $(agentRG)
                      az keyvault secret set --name agentSubnetName --vault-name m-fss-ui-qa-deploy-kv --value $(agentSubnetName)
                      az keyvault secret set --name agentSubscriptionId --vault-name m-fss-ui-qa-deploy-kv --value $(agentSubscriptionId)
                      az keyvault secret set --name agentVnetName --vault-name m-fss-ui-qa-deploy-kv --value $(agentVnetName)
                      az keyvault secret set --name autoTestConfig-apiurl --vault-name m-fss-ui-qa-deploy-kv --value $(autoTestConfig.apiurl)
                      az keyvault secret set --name autoTestConfig-password --vault-name m-fss-ui-qa-deploy-kv --value $(autoTestConfig.password)
                      az keyvault secret set --name autoTestConfig-url --vault-name m-fss-ui-qa-deploy-kv --value $(autoTestConfig.url)
                      az keyvault secret set --name autoTestConfig-user --vault-name m-fss-ui-qa-deploy-kv --value $(autoTestConfig.user)
                      az keyvault secret set --name autoTestConfig-userFullName --vault-name m-fss-ui-qa-deploy-kv --value $(autoTestConfig.userFullName)
                      az keyvault secret set --name b2cConfig-clientId --vault-name m-fss-ui-qa-deploy-kv --value $(b2cConfig.clientId)
                      az keyvault secret set --name b2cConfig-tenantName --vault-name m-fss-ui-qa-deploy-kv --value $(b2cConfig.tenantName)
                      az keyvault secret set --name deploymentResourceGroupName --vault-name m-fss-ui-qa-deploy-kv --value $(DeploymentResourceGroupName)
                      az keyvault secret set --name deploymentStorageAccountName --vault-name m-fss-ui-qa-deploy-kv --value $(DeploymentStorageAccountName)
                      az keyvault secret set --name environment --vault-name m-fss-ui-qa-deploy-kv --value $(Environment)
                      az keyvault secret set --name essConfig-apiScope --vault-name m-fss-ui-qa-deploy-kv --value $(essConfig.apiScope)
                      az keyvault secret set --name essConfig-apiUrl --vault-name m-fss-ui-qa-deploy-kv --value $(essConfig.apiUrl)
                      az keyvault secret set --name essConfig-avgSizeofENCinMB --vault-name m-fss-ui-qa-deploy-kv --value $(essConfig.avgSizeofENCinMB)
                      az keyvault secret set --name essConfig-defaultEstimatedSizeinMB --vault-name m-fss-ui-qa-deploy-kv --value $(essConfig.defaultEstimatedSizeinMB)
                      az keyvault secret set --name essConfig-MaxEncLimit --vault-name m-fss-ui-qa-deploy-kv --value $(essConfig.MaxEncLimit)
                      az keyvault secret set --name essConfig-MaxEncSelectionLimit --vault-name m-fss-ui-qa-deploy-kv --value $(essConfig.MaxEncSelectionLimit)
                      az keyvault secret set --name fssConfig-apiScope --vault-name m-fss-ui-qa-deploy-kv --value $(fssConfig.apiScope)
                      az keyvault secret set --name fssConfig-apiUrl --vault-name m-fss-ui-qa-deploy-kv --value $(fssConfig.apiUrl)
                      az keyvault secret set --name fssConfig-displayPopularSearch --vault-name m-fss-ui-qa-deploy-kv --value $(fssConfig.displayPopularSearch)
                      az keyvault secret set --name fssConfig-stateManagementApiUrl --vault-name m-fss-ui-qa-deploy-kv --value $(fssConfig.stateManagementApiUrl)
                      az keyvault secret set --name googleTagManagerId --vault-name m-fss-ui-qa-deploy-kv --value $(GoogleTagManagerId)
                      az keyvault secret set --name service-dns-url --vault-name m-fss-ui-qa-deploy-kv --value $(SERVICE_DNS_URL)
                      az keyvault secret set --name spokeRG --vault-name m-fss-ui-qa-deploy-kv --value $(spokeRG)
                      az keyvault secret set --name spokeSubnetName --vault-name m-fss-ui-qa-deploy-kv --value $(spokeSubnetName)
                      az keyvault secret set --name spokeVnetName --vault-name m-fss-ui-qa-deploy-kv --value $(spokeVnetName)
                      az keyvault secret set --name waitTimeInMinute --vault-name m-fss-ui-qa-deploy-kv --value $(waitTimeInMinute)
                      az keyvault secret set --name whiteListedIps --vault-name m-fss-ui-qa-deploy-kv --value $(whiteListedIps)
      
  - stage: LiveDeploy
    displayName: "Livedeploy (inc terraform, website deploy)"
    jobs:
      - deployment: LiveDeploy
        displayName: "Live - deploy terraform and website"
        environment: "FSS-Live"
        container: ${{variables.Container}}
        workspace:
          clean: all
        variables:
          - group: "File share service terraform Live"
          - group: "File-Share-Service-UI-Live-Variables"
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureCLI@2
                  displayName: "Extract Deployment Variables to deploy KV"
                  inputs:
                    azureSubscription: 'File-Share-Service-Live-P4052'
                    scriptType: 'ps'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      az keyvault secret set --name agentRg --vault-name m-fss-ui-live-deploy-kv --value $(agentRG)
                      az keyvault secret set --name agentSubnetName --vault-name m-fss-ui-live-deploy-kv --value $(agentSubnetName)
                      az keyvault secret set --name agentSubscriptionId --vault-name m-fss-ui-live-deploy-kv --value $(agentSubscriptionId)
                      az keyvault secret set --name agentVnetName --vault-name m-fss-ui-live-deploy-kv --value $(agentVnetName)
                      az keyvault secret set --name autoTestConfig-url --vault-name m-fss-ui-live-deploy-kv --value $(autoTestConfig.url)
                      az keyvault secret set --name b2cConfig-clientId --vault-name m-fss-ui-live-deploy-kv --value $(b2cConfig.clientId)
                      az keyvault secret set --name b2cConfig-tenantName --vault-name m-fss-ui-live-deploy-kv --value $(b2cConfig.tenantName)
                      az keyvault secret set --name deploymentResourceGroupName --vault-name m-fss-ui-live-deploy-kv --value $(DeploymentResourceGroupName)
                      az keyvault secret set --name deploymentStorageAccountName --vault-name m-fss-ui-live-deploy-kv --value $(DeploymentStorageAccountName)
                      az keyvault secret set --name environment --vault-name m-fss-ui-live-deploy-kv --value $(Environment)
                      az keyvault secret set --name essConfig-apiScope --vault-name m-fss-ui-live-deploy-kv --value $(essConfig.apiScope)
                      az keyvault secret set --name essConfig-apiUrl --vault-name m-fss-ui-live-deploy-kv --value $(essConfig.apiUrl)
                      az keyvault secret set --name essConfig-avgSizeofENCinMB --vault-name m-fss-ui-live-deploy-kv --value $(essConfig.avgSizeofENCinMB)
                      az keyvault secret set --name essConfig-defaultEstimatedSizeinMB --vault-name m-fss-ui-live-deploy-kv --value $(essConfig.defaultEstimatedSizeinMB)
                      az keyvault secret set --name essConfig-MaxEncLimit --vault-name m-fss-ui-live-deploy-kv --value $(essConfig.MaxEncLimit)
                      az keyvault secret set --name essConfig-MaxEncSelectionLimit --vault-name m-fss-ui-live-deploy-kv --value $(essConfig.MaxEncSelectionLimit)
                      az keyvault secret set --name fssConfig-apiScope --vault-name m-fss-ui-live-deploy-kv --value $(fssConfig.apiScope)
                      az keyvault secret set --name fssConfig-apiUrl --vault-name m-fss-ui-live-deploy-kv --value $(fssConfig.apiUrl)
                      az keyvault secret set --name fssConfig-displayPopularSearch --vault-name m-fss-ui-live-deploy-kv --value $(fssConfig.displayPopularSearch)
                      az keyvault secret set --name fssConfig-stateManagementApiUrl --vault-name m-fss-ui-live-deploy-kv --value $(fssConfig.stateManagementApiUrl)
                      az keyvault secret set --name googleTagManagerId --vault-name m-fss-ui-live-deploy-kv --value $(GoogleTagManagerId)
                      az keyvault secret set --name service-dns-url --vault-name m-fss-ui-live-deploy-kv --value $(SERVICE_DNS_URL)
                      az keyvault secret set --name spokeRG --vault-name m-fss-ui-live-deploy-kv --value $(spokeRG)
                      az keyvault secret set --name spokeSubnetName --vault-name m-fss-ui-live-deploy-kv --value $(spokeSubnetName)
                      az keyvault secret set --name spokeVnetName --vault-name m-fss-ui-live-deploy-kv --value $(spokeVnetName)
                      az keyvault secret set --name waitTimeInMinute --vault-name m-fss-ui-live-deploy-kv --value $(waitTimeInMinute)
                      az keyvault secret set --name whiteListedIps --vault-name m-fss-ui-live-deploy-kv --value $(whiteListedIps)
